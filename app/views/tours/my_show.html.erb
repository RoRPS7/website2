<script>
      function initMap() {
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer();
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 6,
          center: { lat: 41.85, lng: -87.65 },
        });
        directionsRenderer.setMap(map);
        window.onload = calculateAndDisplayRoute(directionsService, directionsRenderer);
      }

      function calculateAndDisplayRoute(directionsService, directionsRenderer) {
        const waypts = [];
        <% @waypoints_attraction = Attraction.where(id: @tour.attraction_ids) %>
        <% @start_attraction = Attraction.find(@tour.attraction_start_id)%>
        <% @end_attraction = Attraction.find(@tour.attraction_end_id)%>
        <% @waypoints_attraction.each do |attraction| %>
            waypts.push({
              location: new google.maps.LatLng(<%= attraction.x %>,<%= attraction.y %>),
              stopover: true,
            });
            <%end%>
        directionsService.route(
          {
            origin: "<%= @start_attraction.name %>",
            destination: "<%= @end_attraction.name %>",
            waypoints: waypts,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.WALKING,
            avoidTolls: true,
          },
          (response, status) => {
            if (status === "OK" && response) {
              directionsRenderer.setDirections(response);
              const route = response.routes[0];
              const summaryPanel = document.getElementById("directions-panel");
              summaryPanel.innerHTML = "";
              
              // For each route, display summary information.
              summaryPanel.innerHTML += "Start:"
              for (let i = 0; i < route.legs.length; i++) {
                  const routeSegment = i + 1;
                  summaryPanel.innerHTML +=
                  "<b> Segment: " + routeSegment + "</b><br> Instrukcja dotarcia: <br>";
                    summaryPanel.innerHTML += route.legs[i].start_address + " do ";
                    summaryPanel.innerHTML += route.legs[i].end_address + "<br>";
                  for( let j = 0; j < route.legs[i].steps.length; j++)
                    summaryPanel.innerHTML += route.legs[i].steps[j].instructions+ ". ";
                
                summaryPanel.innerHTML += "<br>"
                  route.legs[i].distance.text + "<br><br><br>";
                
              }
            } else {
              window.alert("Directions request failed due to " + status);
            }
          }
        );
      }
    </script>
<p> 
Poniżej przedstawia się Twoja trasa:
</p>
<% @sum_costs = 0 %>
<% @start_attraction = Attraction.find(@tour.attraction_start_id)%>
<% @end_attraction = Attraction.find(@tour.attraction_end_id)%>
<% @sum_costs += @start_attraction.price + @end_attraction.price %>
Atrakcja, z której zaczynasz: <%= @start_attraction.name%>
Atrakcje do obejrzenia podczas trasy:<% @tour.attractions.each do |attraction| %>
<div class="accordion" id="accordionExample">
  <div class="accordion-item">
    <h2 class="accordion-header" id="heading<%=attraction.id%>">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%=attraction.id%>" aria-expanded="true" aria-controls="collapse<%=attraction.id%>">
        <%= attraction.name %>
      </button>
    </h2>
    <div id="collapse<%=attraction.id%>" class="accordion-collapse collapse" aria-labelledby="heading<%=attraction.id%>" data-bs-parent="#accordionExample">
      <div class="accordion-body">
        Krótki opis: <strong><%= attraction.description %></strong>
        Opłata: <strong><%= attraction.price %></strong>
      </div>
    </div>
  </div>
</div>
 <% end %>
<p>

  <% @guide = Guide.find(@tour.guide_id) %>
  <% if !@guide.nil? %>
    <strong>Przewodnik trasy:</strong>
    <%= @guide.name %>
    <%= @guide.surname %>
    <strong> Telefon kontaktowy: </strong>
    <%= @guide.telnumber %>
    <% end %>
</p>
<div id="map" style="width:100%; height: 600px;"></div>
<script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7vOoTEHKZlV89hsFiNdshzf74UMM_dnk&callback=initMap&libraries=&v=weekly"
      async
    ></script>
    <div id="directions-panel"> </div>

<%= button_to "GENERUJ PDF", "#", method: :get, style:"position:relative;top:0;right:0;"%>